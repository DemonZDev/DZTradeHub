name: ðŸ—ï¸ Build DZTradeHub

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    name: ðŸš€ Build Plugin on Ubuntu 24.04
    runs-on: ubuntu-24.04
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ”§ Install SDKMAN!
        run: |
          curl -s "https://get.sdkman.io" | bash
          source "$HOME/.sdkman/bin/sdkman-init.sh"

      - name: â˜• Install Java 21 (Oracle)
        run: |
          source "$HOME/.sdkman/bin/sdkman-init.sh"
          sdk install java 21-oracle
          sdk default java 21-oracle
          java -version

      - name: ðŸ“¦ Install Maven 3.9.11
        run: |
          source "$HOME/.sdkman/bin/sdkman-init.sh"
          sdk install maven 3.9.11
          sdk default maven 3.9.11
          mvn -version

      - name: ðŸ› ï¸ Build DZTradeHub Plugin
        run: |
          source "$HOME/.sdkman/bin/sdkman-init.sh"
          mvn clean package -DskipTests

      - name: ðŸ§¾ Show target contents (debug)
        run: ls -la target || echo "target not present"

      - name: ðŸ”Ž Find built JAR
        id: find_jar
        run: |
          set -e
          jar=$(ls -1 target/*.jar 2>/dev/null | grep -v "original" | grep -v "sources" | head -n1 || true)
          if [ -z "$jar" ]; then
            echo "No jar found in target/ â€” failing."
            exit 1
          fi
          echo "Found jar: $jar"
          echo "jar=$jar" >> $GITHUB_OUTPUT

      - name: ðŸ“¤ Upload Plugin JAR
        uses: actions/upload-artifact@v4
        with:
          name: DZTradeHub
          path: ${{ steps.find_jar.outputs.jar }}
          if-no-files-found: error
